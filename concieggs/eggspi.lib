# Shell script function definitions

decomment() {
    sed 's/ *#.*//' 
}

randomise() {
    sort -R --random-source=/dev/urandom
}

docstring() {
    awk 'BEGIN{indoc=1}\
/^#!/{next}\
/^[^#]/{indoc=0}\
/^# ?$/{next}\
indoc{out = out substr($0, 3, length($0)) " "}\
END{print out}'
}

commasize() {
    awk '{if (out && last) { out = out ", " last; last = $0 }\
else if (out) { last = $0 }\
else { out = $0 } }\
END{ if (last) { if (out) { out = out ", " last } else { out = last } };\
print out }'
}

enumerate() {
    awk '{if (out && last) { out = out ", " last; last = $0 }\
else if (out) { last = $0 }\
else { out = $0 } }\
END{ if (last) { if (out) { out = out " og " last } else { out = last } };\
print out }'
}

ack() {
    (echo "Aj-aj";
        echo "Javel";
        echo "OK";
        echo "Forstået";
        echo "Accepteret";
        echo "Det er i orden";
        echo "Roger";
        echo "Priset være Dybber";
	      echo "Dybber er en røvbanan";
        echo "Brian er en ost") \
            | randomise | head -n 1 | xargs echo -n
    (echo "!"; echo ".") | randomise | head -n 1
}

aliases() {
    $EGGS_LIB_DIR/eggstool.py $EGGS_DIR/slashdotfrokost aliases "$1"
}

randomName() {
    aliases "$1" | randomise | head -n 1
}

cmpNames() {
    [ "$(aliases "$1")" = "$(aliases "$2")" ]
}

dateToTime() {
    now="$(nowTime)"
    if (echo "$1" | grep "^-" > /dev/null); then
        then=$(date -d "$(echo $1|sed s/^-//)" '+%s')
        if [ "$then" ]; then
            if [ "$now" -lt "$then" ]; then
                echo $(expr "$then" '-' 3600 '*' 24)
            else
                echo $then
            fi
        fi
    else
        then=$(date -d "$1" '+%s')
        if [ "$then" ]; then
            if [ "$then" -lt "$now" ]; then
                echo $(expr "$then" '+' 3600 '*' 24)
            else
                echo $then
            fi
        fi
    fi
}

nowTime() {
    date '+%s'
}

dateSecs() {
    date -d "1970-01-01 UTC $1 seconds" "$2"
}

timeToFullDate() {
    dateSecs $1 '+%D klokken %R'
}

timeToDate() {
    thatday=$(dateSecs $1 '+%u')
    today=$(dateSecs $(nowTime) '+%u')
    if [ $1 -le "$(expr $(nowTime) - 3600 '*' 24 '*' 7 )" ]; then
        timeToFullDate $1
    elif [ $1 -ge "$(expr $(nowTime) + 3600 '*' 24 '*' 7 )" ]; then
        timeToFullDate $1
    elif [ "$thatday" = "$today" ]; then
        dateSecs $1 '+i dag klokken %R'
    elif [ "$thatday" = "$(expr $today - 1)" -o "(" "$today" = 1 -a "$thatday" = 7 ")" ]; then
        dateSecs $1 '+i går klokken %R'
    elif [ "$thatday" = "$(expr $today + 1)" -o "(" "$today" = 7 -a "$thatday" = 1 ")" ]; then
        dateSecs $1 '+i morgen klokken %R'
    else
        dateSecs $1 '+på %A klokken %R'
    fi
}

daysSince() {
    then=$(date +%s -d "$1")
    now=$(nowTime)
    if [ "$then" -gt "$(expr $now - 3600 '*' 24)" ]; then
        echo "under et døgn"
    elif [ "$then" -gt "$(expr $now - 3600 '*' 24 '*' 2)" ]; then
        echo "omkring et døgn"
    else
        echo "$(expr '(' $now - $then ')' / '(' 3600 '*' 24 ')') dage"
    fi
}

checkNextEggs() {
    time=$(nextEggs | head -n 1)
    if [ ! "$time" ]; then
        return 1
    else
        echo $time
    fi
}

extractDate() {
    while [ $# -ge 1 ]; do
        time=$(dateToTime $1)
        if [ "$time" ]; then
            echo $time
            return 0
        fi
        shift
    done
    checkNextEggs
}

extractUsername() {
    while [ $# -ge 1 ]; do
        name="$(randomName $1)"
        if [ "$name" ]; then
            echo $name
            return 0
        fi
        shift
    done
    randomName $EGGS_USER
}

updateSubTime() {
    aliases "$1" | while read -r alias; do
        dbDelete "$alias/eggsactly";
    done
    dbWriteArg "$1/eggsactly" "$2"
}

addToEggs() {
    if [ $# -eq 3 ]; then
        echo "$2, $3" >> $CONCIEGGS_DB_DIR/eggs/$1
    else
        echo "$2" >> $CONCIEGGS_DB_DIR/eggs/$1
    fi
    updateSubTime "$2" "$(nowTime)"
}

isInEggs() { # Cannot trust return value due to subshell.
    time=$1
    name="$2"
    if [ -s "$CONCIEGGS_DB_DIR/eggs/$time" ]; then
        aliases "$name" | while read alias; do
            if cat $CONCIEGGS_DB_DIR/eggs/$time | sed 's/,.*//' \
                | fgrep -x "$alias"; then
                return 0
            fi
        done
    fi
    return 1
}

rmFromEggs() {
    time=$1
    export TRAITOR="$2"
    tmpfile=$(mktemp)
    cat $CONCIEGGS_DB_DIR/eggs/$time \
        | awk -F, '$1!=ENVIRON["TRAITOR"]' > $tmpfile
    if [ -s $tmpfile ]; then
        mv $tmpfile $CONCIEGGS_DB_DIR/eggs/$time
    else
        rm $tmpfile $CONCIEGGS_DB_DIR/eggs/$time
    fi
    updateSubTime "$TRAITOR" 0
}

nextEggs() {
    export TIME="$(nowTime)"
    ls $CONCIEGGS_DB_DIR/eggs | awk '$1>=ENVIRON["TIME"]'
}

prevEggs() {
    export TIME="$(nowTime)"
    ls $CONCIEGGS_DB_DIR/eggs | awk '$1<ENVIRON["TIME"]'
}

listEggsers() {
    cat $CONCIEGGS_DB_DIR/eggs/$1 | while read who; do
        name=$(echo "$who" | sed 's/,.*//')
        fact=$(echo "$who" | grep "," | sed 's/.*, //')
        if [ "$fact" ]; then
            echo "$(randomName "$name")(*$fact)"
        else
            echo $(randomName "$name")
        fi
    done
}

countEggsers() {
    listEggsers $1 | wc -l | sed 's/ *//'
}

describeEggs() {
    listEggsers $1 | randomise | enumerate
}

formatEggs() {
    date=$(dateSecs $1 '+%Y-%m-%d')
    participants=$(listEggsers $1 | commasize)
    shift
    comment="$*"
    if [ -z $comment ]; then
        echo "$date, $participants"
    else
        echo "$date, $participants # $comment"
    fi
}

gitRefresh() {
    cd /eggsml
    git pull > /dev/null
}

tryGitChange() {
    msg=$1
    shift
    name="$(randomName $EGGS_USER)"
    (git add "$@" && git commit -m "${name:-$EGGS_USER}: $msg" && git push git@github.com:Athas/EggsML.git) > /dev/null
}

gitRepair() {
    (git reset HEAD "$@" && git checkout "$@") > /dev/null
}

debtors () {
    $EGGS_LIB_DIR/eggstool.py $EGGS_DIR/slashdotfrokost balances \
        | sort -g | head -n 5 | awk '$1 < 0 { print $0, -1*$1 "kr" }' \
        | cut -d' ' -f 2- | commasize
}

setTopic () {
    echo /t "$(dbRead topic)  --  Største skyldnere: $(debtors)."
}

authedName () {
    cd $CONCIEGGS_IRC_DIR
    rm -rf nickserv
    echo '/PRIVMSG nickserv :info '$1 > in
    for i in $(seq 1 5); do
        authed=$(awk '{ match($0, "account[^a-zA-Z0-9_]+([a-zA-Z0-9_]+)", a); if (a[1]) { print a[1] }}' < nickserv/out)
        if [ "$authed" ]; then
            echo $authed
            return
        fi
        unknown=$(awk '/is not registered/' < nickserv/out)
        if [ "$unknown" ]; then
            return
        fi
        sleep 1
    done
}

isTrusted() {
    auth="$(authedName "$1")"
    if [ "$auth" ]; then
        cat "$CONCIEGGS_DB_DIR/mestre" | decomment | fgrep -x "$auth"
    fi
}

broke() {
    echo "Kommandoen fejlede!  Prøv at spørge mig om 'udu'."
}

runcmd() {
    rawcmd=$1
    cmd="$(basename -- "$rawcmd")"
    cmddir=$CONCIEGGS_DIR/cmds
    shift
    echo "Jeg er til FOSDEM!"
    exit
    if [ "$cmd" ] && [ "$EGGS_USER" != "$CONCIEGGS_NAME" ]; then
        if [ -x "$cmddir/$cmd" ] && [ -f "$cmddir/$cmd" ]; then
            "$cmddir/$cmd" "$@" || broke
        else
            echo "$EGGS_USER: Du bad mig om $cmd, men den kommando har jeg ikke!"
            echo "Skriv 'concieggs: kommandoer' for at få en liste over mulige kommandoer."
        fi
    fi
}

lookupDebt() {
    who=$1
    # ja, vi beregner alles gæld, selv om vi kun er interesseret i et
    # enkelt af tallene
    $EGGS_LIB_DIR/eggstool.py $EGGS_DIR/slashdotfrokost balances | while read -r line; do
        name="$(echo "$line" | cut -d' ' -f 2)"
        if cmpNames "$name" "$who"; then
            echo "$line" | cut -d' ' -f 1 | awk '{ print -1*$0 }'
            return
        fi
    done
}

# Database layer

dbRead() {
    [ -f "$CONCIEGGS_DB_DIR/store/$1" ] && cat "$CONCIEGGS_DB_DIR/store/$1"
}

dbWrite() {
    mkdir -p "$CONCIEGGS_DB_DIR/store/$(dirname $1)"
    cat > "$CONCIEGGS_DB_DIR/store/$1"
}

dbNewNode() {
    mkdir -p "$CONCIEGGS_DB_DIR/store/$1"
}

dbWriteArg() {
    dest=$1
    shift
    echo "$@"| dbWrite "$dest"
}

dbDelete() {
    rm -rf "$CONCIEGGS_DB_DIR/store/$1"
}

dbIterate() {
    [ -d "$CONCIEGGS_DB_DIR/store/$1" ] \
        && ls "$CONCIEGGS_DB_DIR/store/$1" | while read -r child; do
        echo "$1/$child"
    done
}

dbGetFreeFilename() {
    parent=$1
    if [ -f "$CONCIEGGS_DB_DIR/store/$1" ] \
        || ! mkdir -p "$CONCIEGGS_DB_DIR/store/$parent"; then
        false
    else
        newfile="$(ls "$CONCIEGGS_DB_DIR/store/$parent" | \
            egrep '^[0-9]+$'|sort -n| \
            awk 'BEGIN { seen=-1 } { if ($0==seen+1) { seen++ } else { print seen+1; exit }} END { print seen+1 }')"
        echo "$parent/$newfile"
    fi
}

dbInsertNode() {
    node=$(dbGetFreeFilename "$1")
    dbNewNode "$node" && echo "$node"
}

dbInsertData() {
    node=$(dbGetFreeFilename "$1")
    dbWrite "$node" && echo "$node"
}
