# Shell script function definitions

aliases() {
    $EGGS_LIB_DIR/eggstool.py $EGGS_DIR/slashdotfrokost aliases "$1"
}

export -f aliases

primaryName() {
    aliases "$1" | head -n 1
}

export -f primaryName

randomName() {
    aliases "$1" | sort -R | head -n 1
}

export -f randomName

dateToTime() {
    then=$(date -d "$1" '+%s')
    now=$(nowTime)
    if [ $then -lt $now ]; then
        echo $(expr $then '*' 3600 '*' 24)
    else
        echo $then
    fi
}

export -f dateToTime

nowTime() {
    date '+%s'
}

export -f nowTime

dateSecs() {
    date -d "1970-01-01 UTC $1 seconds" "$2"
}

timeToFullDate() {
    dateSecs $1 '+%c'
}

export -f timeToFullDate

timeToDate() {
    thatday=$(dateSecs $1 '+%u')
    today=$(dateSecs $(nowTime) '+%u')
    if [ $1 -lt $(nowTime) ]; then
        timeToFullDate $1
    elif [ $1 -ge $(expr $(nowTime) + 3600 '*' 24 '*' 7 ) ]; then
        timeToFullDate $1
    elif [ $thatday == $today ]; then
        dateSecs $1 '+i dag klokken %R'
    elif [ $thatday == $(expr $today + 1) -o "(" $today == 7 -a $thatday == 1 ")" ]; then
        dateSecs $1 '+i morgen klokken %R'
    else
        dateSecs $1 '+pÃ¥ %A klokken %R'
    fi
}

export -f timeToDate

addToEggs() {
    time=$(dateToTime "$1")
    echo $2 >> $CONCIEGGS_DB_DIR/eggs/$time
}

export -f addToEggs

isInEggs() { # Cannot trust return value due to subshell.
    time=$(dateToTime "$1")
    if [ -s $CONCIEGGS_DB_DIR/eggs/$time ]; then
        aliases $2 | while read alias; do
            if fgrep $alias $CONCIEGGS_DB_DIR/eggs/$time; then
                return 0
            fi
        done
    fi
    return 1
}

export -f isInEggs

rmFromEggs() {
    time=$(dateToTime "$1")
    export TRAITOR=$2
    tmpfile=$(mktemp)
    cat $CONCIEGGS_DB_DIR/eggs/$time \
        | awk '$1!=ENVIRON["TRAITOR"]' > $tmpfile
    if [ -s $tmpfile ]; then
        mv $tmpfile $CONCIEGGS_DB_DIR/eggs/$time
    else
        rm $tmpfile $CONCIEGGS_DB_DIR/eggs/$time
    fi
}

export -f rmFromEggs

nextEggs() {
    export TIME=$(nowTime)
    ls $CONCIEGGS_DB_DIR/eggs | awk '$1>=ENVIRON["TIME"]'
}

export -f nextEggs

prevEggs() {
    export TIME=$(nowTime)
    ls $CONCIEGGS_DB_DIR/eggs | awk '$1<ENVIRON["TIME"]'
}

export -f prevEggs
