#!/bin/sh

set -e

dir=$(dirname $0)
cfg=$dir/concieggs.conf
source $cfg
cmddir=$dir/cmds/

export CONCIEGGS_DIR=$dir
export CONCIEGGS_DB_DIR=$dir/db
export EGGS_DIR=$dir/..
export EGGS_LIB_DIR=$EGGS_DIR/eggslib

echo "Using channel in $irc_dir/localhost/&eggs"
cd $irc_dir/localhost/'&eggs'

# Right on - read commands and be merry.

awk_getcmd='/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2} <[A-Za-z0-9_]*> '$irc_username': / { print $5; }'
awk_getuser='{ print substr($3, 2, length($3)-2); }'
awk_getline='{ print substr($0, index($0, ": "$5)+length($5)+3, length($0)) }'

broke() {
    echo "Kommandoen fejlede!  Prøv at spørge mig om 'udu'."
}

tail -f -n 0 out | while read line; do
    rawcmd=$(echo "$line"|awk --posix "$awk_getcmd")
    if [ "$rawcmd" ]; then
        cmd=$(basename $rawcmd)
        export EGGS_USER=$(echo "$line"|awk --posix "$awk_getuser")
        export EGGS_ARGS=$(echo "$line"|awk --posix "$awk_getline")
        export EGGS_LINE=$line
        if [ "$cmd" -a "$EGGS_USER" != "$irc_username" ]; then
            if [ -x $cmddir/$cmd ]; then
                source $CONCIEGGS_DIR/eggspi.lib
                $cmddir/$cmd $EGGS_ARGS || broke
            else
                echo "$EGGS_USER: Du bad mig om $cmd, men den kommando har jeg ikke!"
            fi
        fi
    fi
done > in
