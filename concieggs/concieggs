#!/bin/sh

dir=$(dirname $0)
cfg=$dir/concieggs.conf
source $cfg
cmddir=$dir/cmds/

export EGGS_DB_DIR=$dir/db

echo "Using channel in $irc_dir/localhost/&eggs"
cd $irc_dir/localhost/'&eggs'

# Right on - read commands and be merry.

awk_getcmd='/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2} <[A-Za-z0-9_]*> '$irc_username': / { print $5; }'
awk_getuser='{ print substr($3, 2, length($3)-2); }'
awk_getline='{ print substr($0, index($0, ": ")+2, length($0)) }'

tail -f -n 0 out | while read line; do
    cmd=$(echo "$line"|awk --posix "$awk_getcmd")
    export EGGS_USER=$(echo "$line"|awk --posix "$awk_getuser")
    export EGGS_ARGS=$(echo "$line"|awk --posix "$awk_getline")
    export EGGS_LINE=$line
    if [ "$cmd" -a "$EGGS_USER" != "$irc_username" ]; then
        if [ -x $cmddir/$cmd ]; then
            $cmddir/$cmd
        else
            echo "$EGGS_USER: Du bad mig om $cmd, men den kommando har jeg ikke!"
        fi
    fi
done > in
