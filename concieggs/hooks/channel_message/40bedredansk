#!/usr/bin/env perl
use 5.012;
use warnings;

use utf8::all;
use Env qw/EGGS_USER CONCIEGGS_DB_DIR/;
use Encode qw/decode/;

my $EGGS_BODY = decode('utf-8', $ENV{EGGS_BODY});
my $CONCIEGGS_NAME = decode('utf-8', $ENV{CONCIEGGS_NAME});

system("shuttingUp");
exit if ($? >> 8) == 0;

exit if $EGGS_USER eq 'hej_fra_github';
exit if $EGGS_BODY =~ qr/^$CONCIEGGS_NAME[,:]/;

my %daneng;
open(my $f, '<', "$CONCIEGGS_DB_DIR/ordbog-engelsk-dansk");
while (my $line = <$f>) {
    my ($from, $to) = $line =~ qr/'([^']+)' '([^']+)'/;
    next unless $from;
    $daneng{$from} = $to;
}
close($f);

sub match_casing {
    my ($a, $b) = @_;
    return $a if $a =~ qr/^".*"$/;
    return "\u$b" if $a =~ qr/^[[:upper:]]/;
    return $b;
}

my $body = $EGGS_BODY;
for my $from (keys %daneng) {
    $body =~ s/(\b$from\b)/match_casing($1,$daneng{$from})/ieg;
}

if ($body ne $EGGS_BODY) {
    my @prefix = (
        "$EGGS_USER mener nok",
        "/me foretrækker nu",
        "$EGGS_USER, her på dansk",
        "/me oversætter",
        "Nejnej, på dansk",
    );
    
    system("annoyedBy $EGGS_USER 2");
    print $prefix[rand @prefix] . ": $body\n";
}
