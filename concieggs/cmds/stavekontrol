#!/usr/bin/env perl
use 5.012;
use warnings;
use utf8::all;

use Text::SpellChecker;

use Env qw/EGGS_USER/;

my $last = `dbUserRead "$EGGS_USER" lastmsg`;
$last //= `dbRead "strangers/$EGGS_USER" lastmsg`;

if ($last) {
    my $checker = Text::SpellChecker->new(text => $last, lang => 'da_DK');
    while (my $word = $checker->next_word) {
        my @suggs = @{ $checker->suggestions };
        if (@suggs) {
            $checker->replace(new_word => $suggs[rand @suggs]);
        } else {
            # No matches! Oh no! Let's just remove a letter and try again.
            my $idx = rand (length $word);
            $word = substr($word, 0, $idx) . substr($word, $idx+1);
            $checker->replace(new_word => $word);
        }
    }
    if ($checker->text ne $last) {
        printf("Rettet: <%s> %s\n", $EGGS_USER, $checker->text);
    } elsif($ARGV[0] != "-q") {
        print "$EGGS_USER: Det ser da fint ud.\n";
    }
} elsif($ARGV[0] != "-q") {
    print "$EGGS_USER: Men du har jo ikke sagt noget!\n";
}
