#!/usr/bin/env python3

import requests
import csv
import random
import re
import math
import sys

deathcsv = requests.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv')
deathreader = csv.reader(deathcsv.text.splitlines()[1:])

deaths = 0
deathsPerCountry = {}
for row in deathreader:
    deaths += int(row[-1])
    try:
        deathsPerCountry[row[1]] += int(row[-1])
    except KeyError:
        deathsPerCountry[row[1]] = int(row[-1])

confirmedcsv = requests.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv')
confirmedreader = csv.reader(confirmedcsv.text.splitlines()[1:])

confirmed = 0
confirmedPerCountry = {}
for row in confirmedreader:
    confirmed += int(row[-1])
    try:
        confirmedPerCountry[row[1]] += int(row[-1])
    except KeyError:
        confirmedPerCountry[row[1]] = int(row[-1])

countries = {'Kina': 'Mainland China', 'et krydstogskib': '', 'Sydkorea': 'South Korea', 'Japan': 'Japan', 'Italien': 'Italy', 'Singapore': 'Singapore', 'Hongkong': 'Hong Kong', 'Iran': 'Iran', 'Amerikas forenede stater': 'US', 'Thailand': 'Thailand', 'Taiwan': 'Taiwan', 'Australien': 'Australia', 'Malaysien': 'Malaysia', 'Tyskland': 'Germany', 'Vietnam': 'Vietnam', 'de Forenede Arabiske Emirater': 'United Arab Emirates', 'Frankrig': 'France', 'Macau': 'Macau', 'Canada': 'Canada', 'det Forenede Kongerige': 'UK', 'Filippinerne': 'Philippines', 'Indien': 'India', 'Rusland': 'Russia', 'Spanien': 'Spanien', 'Irak': 'Iraq', 'Israel': 'Israel', 'Lebanon': 'Lebanon', 'Sverige': 'Sweden', 'Belgien': 'Belgium', 'Cambodien': 'Cambodia', 'Ægypten': 'Egypt', 'Finland': 'Finland', 'Nepal': 'Nepal', 'Srilanka': 'Sri Lanka', 'Schweiz': 'Switzerland', 'Danmark': 'Denmark'}
alternatives = {'US': 'Amerikas forenede stater', 'DK': 'Danmark'}

idx = ''
if len(sys.argv) > 1:
    try:
        c = alternatives[' '.join(sys.argv[1:])]
    except KeyError:
        c = sys.argv[1]
    try:
        idx = countries[c]
        try:
            deaths = deathsPerCountry[idx]
        except KeyError:
            deaths = 0
        try:
            confirmed = confirmedPerCountry[idx]
        except KeyError:
            confirmed = 0
    except KeyError:
        print('Æh, jeg har altså ikke hørt om %s' % (c))

if idx != '':
    if confirmed == 0:
        print('Coronavirussen har sgu\' ikke berørt nogen i %s endnu.  Måske du skulle hjælpe lidt til?' % c)
    else:
        print('Coronavirussen har indtil videre slået %d mennesker ihjel og smittet %d i %s. Det svarer til en succesrate på %.2f%%!' % (deaths, confirmed, c, deaths / confirmed * 100))
else:
    print('Coronavirussen har indtil videre slået %d mennesker ihjel og smittet %d. Det svarer til en succesrate på %.2f%%!' % (deaths, confirmed, deaths / confirmed * 100))

msgs = ['Hvem mon bliver nummer %d?' % (deaths+1)]
if confirmed > 0:
    msgs.append('Kan vi få den op på %d%%?' % math.ceil(deaths / confirmed * 100))

if idx == '':
    msgs.append('Du kan hjælpe ved at tage til %s og indånde folks hoste, og derefter hoste på andre mennesker.' % random.choice(list(countries.keys())))
else:
    msgs.append('Du kan hjælpe ved at tage til %s og indånde folks hoste, og derefter hoste på andre mennesker.' % c)

print(random.choice(msgs))
