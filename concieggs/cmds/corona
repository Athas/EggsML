#!/usr/bin/env python3

import requests
import csv
import random
import re
import math
import sys

deathcsv = requests.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv')
deathreader = csv.reader(deathcsv.text.splitlines()[1:])

deaths = 0
deathsPerCountry = {}
for row in deathreader:
    try:
        i = int(row[-1])
    except ValueError:
        i = 0
    deaths += i
    try:
        deathsPerCountry[row[1]] += i
    except KeyError:
        deathsPerCountry[row[1]] = i

confirmedcsv = requests.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv')
confirmedreader = csv.reader(confirmedcsv.text.splitlines()[1:])

confirmed = 0
confirmedPerCountry = {}
for row in confirmedreader:
    try:
        i = int(row[-1])
    except ValueError:
        i = 0
    confirmed += i
    try:
        confirmedPerCountry[row[1]] += i
    except KeyError:
        confirmedPerCountry[row[1]] = i

countries = {'Kina': 'China', 'et krydstogskib': '', 'Sydkorea': 'Korea, South', 'Japan': 'Japan', 'Italien': 'Italy', 'Singapore': 'Singapore', 'Hongkong': 'Hong Kong', 'Iran': 'Iran', 'Amerikas forenede stater': 'US', 'Thailand': 'Thailand', 'Taiwan': 'Taiwan', 'Australien': 'Australia', 'Malaysien': 'Malaysia', 'Tyskland': 'Germany', 'Vietnam': 'Vietnam', 'de Forenede Arabiske Emirater': 'United Arab Emirates', 'Frankrig': 'France', 'Macau': 'Macau', 'Canada': 'Canada', 'det Forenede Kongerige': 'United Kingdom', 'Filippinerne': 'Philippines', 'Indien': 'India', 'Rusland': 'Russia', 'Spanien': 'Spain', 'Irak': 'Iraq', 'Israel': 'Israel', 'Lebanon': 'Lebanon', 'Sverige': 'Sweden', 'Belgien': 'Belgium', 'Cambodien': 'Cambodia', 'Ægypten': 'Egypt', 'Finland': 'Finland', 'Nepal': 'Nepal', 'Srilanka': 'Sri Lanka', 'Schweiz': 'Switzerland', 'Danmark': 'Denmark', 'Østrig': 'Austria', 'Oman': 'Oman', 'Afghanistan': 'Afghanistan', 'Kuwait': 'Kuwait', 'Kroatien': 'Croatia', 'Bahrain': 'Bahrain', 'Pakistan': 'Pakistan', 'Brasilien': 'Brazi;', 'Georgien': 'Georgia', 'Grækenland': 'Greece', 'Makedonien': 'North Macedonia', 'Norge': 'Norway', 'Rumænien': 'Romania', 'Letland': 'Latvia', 'Litauen': 'Lithuania', 'Estland': 'Estonia', 'Bulgarien': 'Bulgaria', 'Luxemborg': 'Luxembourg','Polen': 'Poland','Færøerne': 'Faroe Islands','Grønland': 'Greenland', 'Sydafrika': 'South Africa','Slovenien': 'Slovenia','Bosnien og Herzegovinien':'Bosnia and Herzegovina','Palæstina':'Palestine','Ungarn':'Hungary','Saudiarabien':'Saudi Arabia','Algeriet':'Algeria','Vatikanet':'Vatican City','Nederlandene':'Netherlands','Irland':'Ireland', 'Slovakiet': 'Slovakia', 'Tjekkiet': 'Czechia', 'Kypern': 'Cyprus'}
groupings = {'den Europæiske Union': ['Belgien', 'Bulgarien', 'Kypern', 'Danmark', 'Estland', 'Finland', 'Frankrig', 'Grækenland', 'Irland', 'Italien', 'Kroatien', 'Letland', 'Litauen', 'Luxemborg', 'Malta', 'Nederlandene', 'Polen', 'Portugal', 'Rumænien', 'Slovakiet', 'Slovenien', 'Spanien', 'Sverige', 'Tjekkiet', 'Tyskland', 'Ungarn', 'Østrig']}
alternatives = {'US': 'Amerikas forenede stater', 'USA': 'Amerikas forenede stater', 'Amerika': 'Amerikas forenede stater', 'DK': 'Danmark', 'Q8': 'Kuwait', 'Pavestaten': 'Vatikanet', 'UK': 'det Forenede Kongerige', 'EU': 'den Europæiske Union'}

for group, members in groupings.items():
    groupDeaths = 0
    groupConfirmed = 0
    for member in members:
        try:
            idx = countries[member]
            groupDeaths += deathsPerCountry[idx]
            groupConfirmed += confirmedPerCountry[idx]
        except KeyError:
            pass
    deathsPerCountry[group] = groupDeaths
    confirmedPerCountry[group] = groupConfirmed

idx = ''
if len(sys.argv) > 1:
    if ' '.join(sys.argv[1:]) == 'højest':
        # find land med højeste dødelighed
        highest = 0.0
        c = ''
        for country, deaths in deathsPerCountry.items():
            confirmed = confirmedPerCountry[country]
            if deaths > 0 and deaths / confirmed > highest:
                highest = deaths / confirmed
                c = country
    elif ' '.join(sys.argv[1:]) == 'flest':
        # find land med flest smittede (nok Kina)
        most = 0
        c = ''
        for country, confirmed in confirmedPerCountry.items():
            if confirmed > most:
                most = confirmed
                c = country
    else:
        try:
            c = alternatives[' '.join(sys.argv[1:])]
        except KeyError:
            c = ' '.join(sys.argv[1:])
    try:
        idx = countries[c]
    except KeyError:
        try:
            test = confirmedPerCountry[c]
            idx = c
            for dansk, engelsk in countries.items():
                if idx == engelsk:
                    c = dansk
                    break
        except KeyError:
            print('Æh, jeg har altså ikke hørt om %s' % (c))
    if idx != '':
        try:
            deaths = deathsPerCountry[idx]
        except KeyError:
            deaths = 0
        try:
            confirmed = confirmedPerCountry[idx]
        except KeyError:
            confirmed = 0

if idx != '':
    if confirmed == 0:
        print('Coronavirussen har sgu\' ikke berørt nogen i %s endnu.  Måske du skulle hjælpe lidt til?' % c)
    else:
        print('Coronavirussen har indtil videre slået {0:n} mennesker ihjel og smittet {1:n} i {2}. Det svarer til en succesrate på {3:n}%!'.format(deaths, confirmed, c, round(deaths / confirmed * 100, 2)))
else:
    print('Coronavirussen har indtil videre slået {0:n} mennesker ihjel og smittet {1:n}. Det svarer til en succesrate på {2:n}%!'.format(deaths, confirmed, round(deaths / confirmed * 100, 2)))

msgs = ['Hvem mon bliver nummer {0:n}?'.format(deaths+1)]
if confirmed > 0:
    msgs.append('Kan vi få den op på {0:n}%?'.format(round(math.floor(deaths / confirmed * 100 + 1),2)))

if idx == '':
    msgs.append('Du kan hjælpe ved at tage til %s og indånde folks hoste, og derefter hoste på andre mennesker.' % random.choice(list(countries.keys())))
else:
    msgs.append('Du kan hjælpe ved at tage til %s og indånde folks hoste, og derefter hoste på andre mennesker.' % c)

print(random.choice(msgs))
