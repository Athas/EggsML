#!/usr/bin/env python3

import requests
import csv
import random
import re
import math
import sys

deathcsv = requests.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv')
deathreader = csv.reader(deathcsv.text.splitlines()[1:])

deaths = 0
deathsPerCountry = {}
for row in deathreader:
    try:
        i = int(row[-1])
    except ValueError:
        i = 0
    deaths += i
    try:
        deathsPerCountry[row[1]] += i
    except KeyError:
        deathsPerCountry[row[1]] = i

confirmedcsv = requests.get('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv')
confirmedreader = csv.reader(confirmedcsv.text.splitlines()[1:])

confirmed = 0
confirmedPerCountry = {}
for row in confirmedreader:
    try:
        i = int(row[-1])
    except ValueError:
        i = 0
    confirmed += i
    try:
        confirmedPerCountry[row[1]] += i
    except KeyError:
        confirmedPerCountry[row[1]] = i

countries = {'Kina': 'Mainland China', 'et krydstogskib': '', 'Sydkorea': 'Republic of Korea', 'Japan': 'Japan', 'Italien': 'Italy', 'Singapore': 'Singapore', 'Hongkong': 'Hong Kong', 'Iran': 'Iran', 'Amerikas forenede stater': 'US', 'Thailand': 'Thailand', 'Taiwan': 'Taiwan', 'Australien': 'Australia', 'Malaysien': 'Malaysia', 'Tyskland': 'Germany', 'Vietnam': 'Vietnam', 'de Forenede Arabiske Emirater': 'United Arab Emirates', 'Frankrig': 'France', 'Macau': 'Macau', 'Canada': 'Canada', 'det Forenede Kongerige': 'UK', 'Filippinerne': 'Philippines', 'Indien': 'India', 'Rusland': 'Russia', 'Spanien': 'Spain', 'Irak': 'Iraq', 'Israel': 'Israel', 'Lebanon': 'Lebanon', 'Sverige': 'Sweden', 'Belgien': 'Belgium', 'Cambodien': 'Cambodia', 'Ægypten': 'Egypt', 'Finland': 'Finland', 'Nepal': 'Nepal', 'Srilanka': 'Sri Lanka', 'Schweiz': 'Switzerland', 'Danmark': 'Denmark', 'Østrig': 'Austria', 'Oman': 'Oman', 'Afghanistan': 'Afghanistan', 'Kuwait': 'Kuwait', 'Kroatien': 'Croatia', 'Bahrain': 'Bahrain', 'Pakistan': 'Pakistan', 'Brasilien': 'Brazi;', 'Georgien': 'Georgia', 'Grækenland': 'Greece', 'Makedonien': 'North Macedonia', 'Norge': 'Norway', 'Rumænien': 'Romania', 'Letland': 'Latvia', 'Litauen': 'Lithuania', 'Estland': 'Estonia', 'Bulgarien': 'Bulgaria', 'Luxemborg': 'Luxembourg','Polen':'Poland','Færøerne':'Faroe Islands','Grønland':'Greenland','Sydafrika':'South Africa','Slovenien':'Slovenia','Bosnien og Herzegovinien':'Bosnia and Herzegovina','Pælestina':'Palestine','Ungarn':'Hungary','Saudiarabien':'Saudi Arabia','Algeriet':'Algeria','Vatikanet':'Vatican City','Nederlandene':'Netherlands'}
alternatives = {'US': 'Amerikas forenede stater', 'USA': 'Amerikas forenede stater', 'Amerika': 'Amerikas forenede stater', 'DK': 'Danmark', 'Q8': 'Kuwait', 'Pavestaten': 'Vatikanet'}

idx = ''
if len(sys.argv) > 1:
    if ' '.join(sys.argv[1:]) == 'højest':
        # find land med højeste dødelighed
        highest = 0.0
        c = ''
        for country, deaths in deathsPerCountry.items():
            confirmed = confirmedPerCountry[country]
            if deaths > 0 and deaths / confirmed > highest:
                highest = deaths / confirmed
                c = country
    elif ' '.join(sys.argv[1:]) == 'flest':
        # find land med flest smittede (nok Kina)
        most = 0
        c = ''
        for country, confirmed in confirmedPerCountry.items():
            if confirmed > most:
                most = confirmed
                c = country
    else:
        try:
            c = alternatives[' '.join(sys.argv[1:])]
        except KeyError:
            c = ' '.join(sys.argv[1:])
    try:
        idx = countries[c]
    except KeyError:
        try:
            test = confirmedPerCountry[c]
            idx = c
            for dansk, engelsk in countries.items():
                if idx == engelsk:
                    c = dansk
                    break
        except KeyError:
            print('Æh, jeg har altså ikke hørt om %s' % (c))
    if idx != '':
        try:
            deaths = deathsPerCountry[idx]
        except KeyError:
            deaths = 0
        try:
            confirmed = confirmedPerCountry[idx]
        except KeyError:
            confirmed = 0

if idx != '':
    if confirmed == 0:
        print('Coronavirussen har sgu\' ikke berørt nogen i %s endnu.  Måske du skulle hjælpe lidt til?' % c)
    else:
        print('Coronavirussen har indtil videre slået %d mennesker ihjel og smittet %d i %s. Det svarer til en succesrate på %.2f%%!' % (deaths, confirmed, c, deaths / confirmed * 100))
else:
    print('Coronavirussen har indtil videre slået %d mennesker ihjel og smittet %d. Det svarer til en succesrate på %.2f%%!' % (deaths, confirmed, deaths / confirmed * 100))

msgs = ['Hvem mon bliver nummer %d?' % (deaths+1)]
if confirmed > 0:
    msgs.append('Kan vi få den op på %d%%?' % math.floor(deaths / confirmed * 100 + 1))

if idx == '':
    msgs.append('Du kan hjælpe ved at tage til %s og indånde folks hoste, og derefter hoste på andre mennesker.' % random.choice(list(countries.keys())))
else:
    msgs.append('Du kan hjælpe ved at tage til %s og indånde folks hoste, og derefter hoste på andre mennesker.' % c)

print(random.choice(msgs))
