#!/bin/sh
#
# Spørg om din gæld til frokostkassen, eller få hjælp til diverse
# personlighedsfremmende gøremål.  Brug naturligt sprog.

eval "$(echo "$@" | parse 'skylder (?<debtor>[^ ]+)$|har (?<debtor>[^ ]+) til gode$|(?<time>er klokken)$|(?<balance>er betalingsbalancen)$|(?<missing>mangler jeg)$|(?<wtf>hulen)$|(?<status>så)$|(?<meaning>mener (?<who>[^ ]+) med (?<what>[^ ]+)$)|hedder (?<githubname>[^ ]+) på GitHub')"

if [ "$balance" ]; then
  balance="$(lookupBalance)"
  if [ "$(echo "$balance" | grep "-")" ]; then
      echo "Uha, samlet set er der en gæld på $balance kroner."
  else
      echo "Spiser I slet ingen ting? EggsML har et samlet overskud på $balance kroner."
  fi
  exit
fi

if [ "$debtor" ]; then
    if [ "$debtor" = "jeg" ]; then
        alias=$(randomName "$EGGS_USER")
    else
        alias=$(randomName "$debtor")
    fi
    if [ ! "$alias" ]; then
        echo "Jeg kender ikke $debtor."
        exit
    fi

    debt="$(lookupDebt "$alias")"

    if [ "$debt" ]; then
        if [ "$(echo "$debt" | grep "-")" ]; then
            echo "$alias har $(echo $debt | sed 's/-//') kr. til gode i frokostkassen!"
        else
            wish=$(eggstool wishes | randomElement)
            echo "$(Du $alias) skylder $debt kr. til frokostkassen!  $(Du $alias Vedkommende) kunne overveje at købe $wish."
        fi
    else
        echo "Fejl ved beregning af gæld for $alias"
    fi
elif [ "$time" ]; then
    echo "Den store viser peger på $(date +%H), den lille på $(date +%M), og den helt lille på $(date +%S)."
elif [ "$status" ]; then
        reaktion
elif [ "$missing" ]; then
    echo "Du mangler $(randomElement < "$CONCIEGGS_DB_DIR/ordbog-dansk-navneord")!"
elif [ "$wtf" ]; then
    behaviour=$(dbRead outfilter_command)
    user_behaviour=$(dbRead "outfilter_command_$EGGS_USER")
    channel_behaviour=$(dbRead "outfilter_command_$(ircChannel)")
    if [ "$user_behaviour" = "$channel_behaviour" ]; then
        unset $channel_behaviour
    fi
    if [ "$behaviour" ]; then
        echo -n "Mit kulturelle islæt er $behaviour.  "
        if [ "$user_behaviour" ]; then
            echo "Men for din skyld er jeg også $user_behaviour."
        elif [ "$channel_behaviour" ]; then
            echo "Men i disse kamre forsøger jeg passe ind ved $channel_behaviour."
        else
            echo
        fi
    elif [ "$user_behaviour" ]; then
        echo "$EGGS_USER: Som forespurgt, så behandles du efter normerne for $user_behaviour."
    elif [ "$channel_behaviour" ]; then
        echo "$EGGS_USER: Skik følge eller land fly, og i dette land er normen $channel_behaviour."
    else
        echo "$EGGS_USER: Hvad er det helt præcist, der forvirrer dig?  Min adfærd er ganske konventionel."
    fi
    exit
elif [ "$meaning" ]; then
    if [ "$who" = du -o "$who" = "$irc_username" ]; then
        runcmd hjælp "$what"
    else
        if [ "$who" = jeg ]; then
            alias=$(randomName "$EGGS_USER")
        else
            alias=$(randomName "$who")
        fi
        if [ ! "$alias" ]; then
            echo "$EGGS_USER: '$who' er ikke at finde i logeprotokollen."
            exit
        fi
        cmdalias=$(cmdAlias "$alias" "$what")
        if [ "$cmdalias" ]; then
            if [ "$who" = jeg ]; then
                echo "$EGGS_USER: Med '$what', regner jeg naturligvis med at du mener '$cmdalias'."
            else
                echo "$EGGS_USER: Skulle $alias ytre '$what', så antager jeg naturligvis at han mener '$cmdalias'."
            fi
        else
            echo "$EGGS_USER: Ganske som det står skrevet."
        fi
    fi
elif [ "$githubname" ]; then
    if [ "$githubname" = jeg ]; then
        name=$(dbUserRead "$EGGS_USER" githubname)
        if [ "$name" ]; then
            echo "$EGGS_USER: $(Du "$EGGS_USER") hedder sørme '$name'!"
        else
            echo "$EGGS_USER: $(Du "$EGGS_USER") hedder da vist ikke noget.  Fortæl mig det med 'jeg hedder NAVN på GitHub'."
        fi
    else
        name=$(dbUserRead "$githubname" githubname)
        if [ "$name" ]; then
            echo "$EGGS_USER: $(randomName "$githubname") hedder sørme '$name'!"
        else
            echo "$EGGS_USER: $(randomName "$githubname") ser ikke ud til at hedde noget."
        fi
    fi
else
    randomElement <<EOF
$EGGS_USER: Hmm, det er e$(tPattedyr).
$EGGS_USER: E$(tPattedyr) så vidt jeg ved.
Måske e$(tPattedyr), $EGGS_USER?
EOF
    exit
fi
